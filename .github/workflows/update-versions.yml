name: Update versions

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Forward builds
        run: |
          ALL_VERSIONS_RAW=$(curl -s https://hub.spigotmc.org/versions/ | grep -E "*[0-9]\.[0-9]{1,2}(\.[0-9]){0,}?(-pre[0-9]){0,}" -o | uniq | sed 's/\.$//' | sed 's/-pre/~pre/' | sort --version-sort | sed 's/~pre/-pre/')
          declare -a ALL_VERSIONS
          ALL_VERSIONS=($ALL_VERSIONS_RAW)

          for i in "${ALL_VERSIONS[@]}"; do
              curl \
                  --silent \
                  --request POST \
                  --header "Authorization: Bearer ${{ secrets.PAT }}" \
                  --header "Accept: application/vnd.github.v3+json" \
                  --url https://api.github.com/repos/D3strukt0r/docker-spigot/actions/workflows/ci-cd.yml/dispatches \
                  --data "{\"ref\":\"refs/heads/master\",\"inputs\":{\"version\":\"$i\"}}"
          done
